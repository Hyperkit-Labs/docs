const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

/**
 * Get the last commit date for a file using Git
 */
function getLastCommitDate(filePath) {
  try {
    // Get the last commit date for the file
    const gitCommand = `git log -1 --format=%ci -- "${filePath}"`;
    const dateString = execSync(gitCommand, { encoding: 'utf-8', cwd: __dirname + '/..' }).trim();
    
    if (!dateString) {
      // If file is not in Git, use file modification time
      const stats = fs.statSync(filePath);
      return stats.mtime.toISOString();
    }
    
    return new Date(dateString).toISOString();
  } catch (error) {
    // Fallback to file modification time
    try {
      const stats = fs.statSync(filePath);
      return stats.mtime.toISOString();
    } catch {
      return new Date().toISOString();
    }
  }
}

/**
 * Generate last updated metadata for all pages
 */
function generateLastUpdatedMetadata() {
  const appDir = path.join(__dirname, '../app');
  const metadata = {};
  
  function scanDirectory(dir, routePath = '') {
    const entries = fs.readdirSync(dir, { withFileTypes: true });
    
    for (const entry of entries) {
      const fullPath = path.join(dir, entry.name);
      const route = routePath ? `${routePath}/${entry.name}` : entry.name;
      
      if (entry.isDirectory()) {
        scanDirectory(fullPath, route);
      } else if (entry.name === 'page.tsx' || entry.name === 'page.ts') {
        // This is a page file
        const lastUpdated = getLastCommitDate(fullPath);
        const routeKey = routePath || '/';
        metadata[routeKey] = lastUpdated;
      }
    }
  }
  
  scanDirectory(appDir);
  
  // Write metadata to a JSON file
  const jsonPath = path.join(__dirname, '../lib/last-updated-metadata.json');
  fs.writeFileSync(jsonPath, JSON.stringify(metadata, null, 2));
  
  // Also write TypeScript file for import
  const tsPath = path.join(__dirname, '../lib/last-updated-metadata.ts');
  const tsContent = `// This file is auto-generated by scripts/get-last-updated.js
// Do not edit manually - run \`npm run update-metadata\` to regenerate

export const lastUpdatedMetadata: Record<string, string> = ${JSON.stringify(metadata, null, 2)};
`;
  fs.writeFileSync(tsPath, tsContent);
  
  console.log('Generated last updated metadata for', Object.keys(metadata).length, 'pages');
  return metadata;
}

if (require.main === module) {
  generateLastUpdatedMetadata();
}

module.exports = { generateLastUpdatedMetadata, getLastCommitDate };

